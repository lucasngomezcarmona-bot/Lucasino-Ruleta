<script>
// -------------------------
// ELEMENTOS
// -------------------------
const wheel = document.getElementById("wheel");
const spinBtn = document.getElementById("spinBtn");
const coinsEl = document.getElementById("coins");
const addBtn = document.getElementById("add5");

// -------------------------
// MONEDAS (con localStorage)
// -------------------------
let coins = parseInt(localStorage.getItem("coins") || "100");
coinsEl.textContent = "Monedas: " + coins;

function saveCoins() {
  localStorage.setItem("coins", coins);
}

function updateButtons() {
  if (coins <= 0) {
    spinBtn.disabled = true;
    spinBtn.style.opacity = "0.5";
    spinBtn.style.cursor = "not-allowed";
  } else {
    spinBtn.disabled = false;
    spinBtn.style.opacity = "1";
    spinBtn.style.cursor = "pointer";
  }
}

updateButtons();

// -------------------------
// SONIDOS
// -------------------------
const tickSound = new Audio("tick.mp3");     // Sonido tick-tick
const whooshSound = new Audio("whoosh.mp3"); // Sonido continuo

tickSound.volume = 0.6;
whooshSound.volume = 0.5;

// -------------------------
// SECTORES DE LA RULETA
// -------------------------
const segments = [
  { label: "x4", color: "green", multiplier: 4, chance: 10 },
  { label: "x3", color: "green", multiplier: 3, chance: 15 },
  { label: "x2", color: "green", multiplier: 2, chance: 20 },
  { label: "÷4", color: "red", multiplier: -4, chance: 55 }
];

// Convertir porcentajes en una lista expandida
let weighted = [];
segments.forEach(seg => {
  for (let i = 0; i < seg.chance; i++) {
    weighted.push(seg);
  }
});

// -------------------------
// ANIMACIÓN DE GIRO
// -------------------------
let spinning = false;

spinBtn.addEventListener("click", () => {
  if (spinning || coins <= 0) return;

  spinning = true;

  // Coste: 1 giro cuesta 1 moneda
  coins -= 1;
  coinsEl.textContent = "Monedas: " + coins;
  saveCoins();
  updateButtons();

  // Sonido de giro
  whooshSound.currentTime = 0;
  whooshSound.play();

  // Elegir sector ganador
  const result = weighted[Math.floor(Math.random() * weighted.length)];

  // Ángulo correspondiente
  const index = segments.indexOf(result);
  const segmentAngle = 360 / segments.length;
  const targetAngle = (index * segmentAngle) + segmentAngle / 2;

  // Giro grande + ajuste final
  const finalRotation = 3600 + (360 - targetAngle);

  wheel.style.transition = "transform 4s cubic-bezier(.1,.9,.3,1)";
  wheel.style.transform = `rotate(${finalRotation}deg)`;

  // Sonido de ticks mientras gira
  let tickInterval = setInterval(() => {
    tickSound.currentTime = 0;
    tickSound.play();
  }, 120);

  // Final del giro
  setTimeout(() => {
    clearInterval(tickInterval);

    const mult = result.multiplier;

    // Multiplicadores positivos
    if (mult > 0) {
      coins += (1 * mult);
      spawnParticles("green");
    }
    // Penalty ÷4
    else {
      coins = Math.floor(coins / 4);
      spawnParticles("red");
    }

    coinsEl.textContent = "Monedas: " + coins;
    saveCoins();
    updateButtons();

    wheel.style.transition = "none";
    spinning = false;
  }, 4100);
});

// -------------------------
// BOTÓN +5 MONEDAS
// -------------------------
addBtn.addEventListener("click", () => {
  coins += 5;
  coinsEl.textContent = "Monedas: " + coins;
  saveCoins();
  updateButtons();
});

// -------------------------
// PARTÍCULAS
// -------------------------
function spawnParticles(color) {
  for (let i = 0; i < 20; i++) {
    const p = document.createElement("div");
    p.classList.add("particle");
    p.style.background = color;
    document.body.appendChild(p);

    const x = window.innerWidth / 2;
    const y = window.innerHeight / 2;
    p.style.left = `${x}px`;
    p.style.top = `${y}px`;

    const angle = Math.random() * Math.PI * 2;
    const distance = 80 + Math.random() * 40;

    const dx = Math.cos(angle) * distance;
    const dy = Math.sin(angle) * distance;

    setTimeout(() => {
      p.style.transform = `translate(${dx}px, ${dy}px) scale(0)`;
      p.style.opacity = "0";
    }, 10);

    setTimeout(() => {
      p.remove();
    }, 900);
  }
}
</script>
